<html>

<head>
    <title>
        Bubbles
    </title>
    <script type="module">
        import { RANDOM } from './out/types.js';
        import { BubbleSimulator } from './out/bubble_simulator.js';
        import { randomInRange } from './out/util.js';
        import { buildParsers } from './out/message_parsing.js';
        import { RadiusConfig } from './out/config_modal/radius_config.js';
        import { sendTestSetupMessage, sendTestDataMessage } from './out/test_util.js';

        const DEBUG_MODE = false;
        const WS_SERVER = "ws://127.0.0.1:3001";
        const WS_PROTOCOL = "bubbler-v0";

        let bubbler;
        let bubbleConfig = {
            'radiusType': RANDOM,
            'minRadius': 25,
            'maxRadius': 100
        };
        let bubbleParsers = buildParsers(bubbleConfig);
        let ws;

        function start() {
            ReactDOM.createRoot(document.getElementById("settings")).render(
                React.createElement(RadiusConfig, { 'onSave': onConfigChange })
            );

            bubbler = new BubbleSimulator(document.getElementById('bubbles'));
            bubbler.start();

            const shareButton = document.getElementById("share");

            const copyUrlIcon = document.getElementById("copyUrlIcon");
            copyUrlIcon.onclick = copyUrlToClipboard;

            if (DEBUG_MODE) {
                sendTestSetupMessage(handleWsMessage);
                sendTestDataMessage(handleWsMessage);
                setInterval(() => sendTestDataMessage(handleWsMessage), 5000);
                shareButton.style.color = 'lightgray'; // Not enabled in debug mode
            } else {
                const restoreKey = new URL(window.location).searchParams.get('restoreFrom');
                const wsUrl = restoreKey ? WS_SERVER + "/" + restoreKey : WS_SERVER;
                ws = new WebSocket(wsUrl, WS_PROTOCOL);
                ws.onmessage = handleWsMessage;
                shareButton.addEventListener('click', persist);
            }
        }

        function persist() {
            ws.send(JSON.stringify({
                'type': 'persist',
                'currentConfig': bubbleConfig
            }));
        }

        function onConfigChange(newConfig) {
            bubbleConfig = newConfig;
            bubbleParsers = buildParsers(newConfig);
        }

        function setWebhookUrl(url) {
            document.getElementById("webhookUrl").innerText = url;
        }

        function handleWsMessage(event) {
            const msg = JSON.parse(event.data);
            if (msg.type == "setupInfo") {
                setWebhookUrl(msg.webhookUrl);
            }
            else if (msg.type == "restoredSetupInfo") {
                setWebhookUrl(msg.webhookUrl);
                onConfigChange(msg.config);
            }
            else if (msg.type == "webhookMessage") {
                let value = bubbleParsers.fieldExtractor(msg['dataFromWebhook']);
                bubbler.addBubble(bubbleParsers.radiusMapper(value), bubbleParsers.colorMapper(value));
            }
            else if (msg.type == "hookPersisted") {
                showPersistedModal(msg.restoreKey);
            }
            else {
                console.error(`Unexpected message type: ${msg.type}`);
            }
        }

        function showPersistedModal(restoreKey) {
            const currentUrl = new URL(window.location);
            currentUrl.searchParams.set('restoreFrom', restoreKey);

            document.getElementById("persistedModalUrl").innerText = currentUrl;
            const modal = new bootstrap.Modal(document.getElementById('persistedModal'));
            modal.show();
        }

        function copyUrlToClipboard(clickedElement) {
            const tooltip = bootstrap.Tooltip.getOrCreateInstance(clickedElement.target, {
                title: 'Copied!',
                trigger: 'focus'
            });
            navigator.clipboard.writeText(document.getElementById('persistedModalUrl').textContent);
            tooltip.show();
            setTimeout(() => {
                tooltip.hide();
            }, 300);
        }

        document.addEventListener('DOMContentLoaded', start);
    </script>

    <style>
        body {
            padding: 0;
            margin: 0;
        }

        div#webhookInfo {
            position: absolute;
            margin-top: 10%;
            width: 100%;

            display: flex;
            justify-content: center;
            align-items: center;

            font-size: 3rem;
        }

        div#settings {
            cursor: pointer;
        }

        div#settingsAndShare {
            position: absolute;
            width: 100%;
            padding-right: 1.2rem;
            padding-top: 1.2rem;

            display: flex;
            flex-direction: row;
            justify-content: flex-end;
            gap: 0.7rem;
            font-size: 1.3rem;
        }

        span#settingButton>i {
            margin-right: 0.2rem;
        }

        .settings-modal-body {
            min-height: 600px;
        }

        #persistedModalUrl {
            margin-top: 1rem;
            word-break: break-all;
        }
    </style>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <!-- Bootstrap icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">
</head>

<body>
    <div id="settingsAndShare">
        <div id="settings"></div>
        <div id="share">
            <i class="bi bi-share" role="button"></i>
        </div>
    </div>

    <div id="webhookInfo">
        <span id="webhookUrl"></span>
    </div>

    <canvas id="bubbles"></canvas>

    <div id="persistedModal" class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title w-100 text-center">Saved!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body-persist modal-body">
                    <div class="text-center">
                        Restore this webhook URL and configuration by visiting
                    </div>

                    <div class="row align-items-center">
                        <div class="col-1"></div>
                        <div class="col-10">
                            <p id="persistedModalUrl" class="text-muted text-center user-select-all"></p>
                        </div>
                        <div class="col-1">
                            <i id="copyUrlIcon" tabindex="0" class="bi bi-clipboard" role="button"></i>
                            <p id="persistedModalUrl" class="text-muted text-center"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
        crossorigin="anonymous"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
</body>

</html>