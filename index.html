<html>

<head>
    <title>
        Bubbles
    </title>
    <script type="application/javascript">
        const WS_SERVER = "ws://127.0.0.1:3001";
        const WS_PROTOCOL = "bubbler-v0";
        const TICK_MS = 20; // 50 FPS
        const FLOAT_SPEED = 0.6;
        let lastRender;

        const bubbles = [];

        function addBubble(targetValue) {
            bubbles.push({
                // Spawn at a random horizontal position, fully inside the viewport:
                "x": randomInRange(targetValue, window.innerWidth - targetValue),
                // Spawn just below the viewport:
                "y": window.innerHeight + targetValue,
                "r": targetValue,
                "fillStyle": fillFor(targetValue)
            });
        }

        function randomInRange(minInclusive, maxInclusive) {
            return Math.floor(Math.random() * (maxInclusive - minInclusive + 1) + minInclusive);
        }

        function fillFor(targetValue) {
            return "red";
        }

        function start() {
            const ws = new WebSocket(WS_SERVER, WS_PROTOCOL);
            ws.onmessage = handleWsMessage;

            window.requestAnimationFrame(render);
        }

        function handleWsMessage(event) {
            var msg = JSON.parse(event.data);
            if (msg.type == "setupInfo") {
                document.getElementById("webhookInfo").innerText = msg.webhookUrl;
            } else if (msg.type == "webhookMessage") {
                addBubble(randomInRange(25, 100));
            } else {
                console.log(`Unexpected message type: ${msg.type}`);
            }
        }

        function render(timestamp) {
            if (lastRender === undefined) {
                lastRender = timestamp;
            }

            if (timestamp - lastRender > TICK_MS) {
                var canvas = document.getElementById("bubbles");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                var ctx = canvas.getContext('2d');
                for (let i = bubbles.length - 1; i >= 0; i--) {
                    const bubble = bubbles[i];

                    bubble.y -= FLOAT_SPEED;
                    if (bubble.y < -bubble.r) {
                        // Fully out of view, remove it:
                        bubbles.splice(i, 1);
                    }
                    ctx.arc(bubble.x, bubble.y, bubble.r, 0, 2 * Math.PI, false);
                    ctx.fillStyle = bubble.fillStyle;
                    ctx.fill();
                }
            }

            window.requestAnimationFrame(render);
        }
    </script>

    <style>
        body {
            padding: 0;
            margin: 0;
        }

        div#webhookInfo {
            position: absolute;
            width: 100%;
            display: flex;
            justify-content: center;
            padding-top: 10%;
            font-size: 50px;
        }
    </style>
</head>

<body onload="start();">
    <div id="webhookInfo"></div>
    <canvas id="bubbles"></canvas>
</body>



</html>