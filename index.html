<html>

<head>
    <title>
        Bubbles
    </title>
    <script type="module">
        import { RadiusConfig } from './out/radius_config.js';

        const DEBUG_MODE = true;
        const WS_SERVER = "ws://127.0.0.1:3001";
        const WS_PROTOCOL = "bubbler-v0";
        const TICK_MS = 20; // 50 FPS
        const FLOAT_SPEED = 0.6;
        const COLORS = ['red', 'green', 'blue', 'purple', 'yellow', 'orange'];
        let lastRender;

        function randomColor() {
            return COLORS[randomInRange(0, COLORS.length - 1)];
        }

        const bubbles = [];
        const bubbleConfig = {
            fieldExtractor: () => randomInRange(25, 100),
            radiusMapper: r => r,
            colorMapper: randomColor
        }

        function extractNumericOrDefault(extractor, defaultValue) {
            return data => {
                const extracted = extractor(data);
                if (typeof extracted == 'number') {
                    return extracted;
                } else {
                    return defaultValue;
                }
            }
        }

        function nestedFieldExtractor(fields) {
            return data => {
                let currentNode = data;
                for (let field of fields) {
                    currentNode = currentNode[field];
                    if (currentNode === undefined) {
                        return undefined;
                    }
                }
                return currentNode;
            };
        }

        function addBubble(radius, fill) {
            bubbles.push({
                // Spawn at a random horizontal position, fully inside the viewport:
                "x": randomInRange(radius, window.innerWidth - radius),
                // Spawn just below the viewport:
                "y": window.innerHeight + radius,
                "r": radius,
                "fillStyle": fill
            });
        }

        function randomInRange(minInclusive, maxInclusive) {
            return Math.floor(Math.random() * (maxInclusive - minInclusive + 1) + minInclusive);
        }

        function onConfigChange(newConfig) {
            console.log("New config!", newConfig);
        }

        function start() {
            ReactDOM.createRoot(document.getElementById("settings")).render(
                React.createElement(RadiusConfig, {'onSave': onConfigChange})
            );

            if (DEBUG_MODE) {
                sendTestSetupMessage();
                sendTestDataMessage();
                setInterval(sendTestDataMessage, 5000);
            } else {
                const ws = new WebSocket(WS_SERVER, WS_PROTOCOL);
                ws.onmessage = handleWsMessage;
            }
            window.requestAnimationFrame(render);
        }

        function handleWsMessage(event) {
            const msg = JSON.parse(event.data);
            if (msg.type == "setupInfo") {
                document.getElementById("webhookUrl").innerText = msg.webhookUrl;
            } else if (msg.type == "webhookMessage") {
                let value = bubbleConfig.fieldExtractor(msg['dataFromWebhook']);
                addBubble(bubbleConfig.radiusMapper(value), bubbleConfig.colorMapper(value));
            } else {
                console.log(`Unexpected message type: ${msg.type}`);
            }
        }

        function render(timestamp) {
            if (lastRender === undefined) {
                lastRender = timestamp;
            }

            if (timestamp - lastRender > TICK_MS) {
                const canvas = document.getElementById("bubbles");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                const ctx = canvas.getContext('2d');
                for (let i = bubbles.length - 1; i >= 0; i--) {
                    const bubble = bubbles[i];

                    bubble.y -= FLOAT_SPEED;
                    if (bubble.y < -bubble.r) {
                        // Fully out of view, remove it:
                        bubbles.splice(i, 1);
                    }
                    ctx.beginPath();
                    ctx.arc(bubble.x, bubble.y, bubble.r, 0, 2 * Math.PI, false);
                    ctx.fillStyle = bubble.fillStyle;
                    ctx.fill();
                }
            }

            window.requestAnimationFrame(render);
        }

        function sendTestSetupMessage() {
            handleWsMessage({
                "data": JSON.stringify({
                    "type": "setupInfo",
                    "webhookUrl": "http://localhost:3000/mAdS"
                })
            });
        }

        function sendTestDataMessage() {
            handleWsMessage({
                "data": JSON.stringify({
                    "type": "webhookMessage",
                    "dataFromWebhook": {
                        "room": {
                            "data": {
                                "temperature": randomInRange(5, 100)
                            }
                        }
                    }
                })
            });
        }

        document.addEventListener('DOMContentLoaded', start);
    </script>

    <style>
        body {
            padding: 0;
            margin: 0;
        }

        div#webhookInfo {
            position: absolute;
            margin-top: 10%;
            width: 100%;

            display: flex;
            justify-content: center;
            align-items: center;

            font-size: 50px;
        }

        div#settings {
            position: absolute;
            width: 100%;
            padding-right: 0.5rem;
            padding-top: 0.5rem;

            display: flex;
            justify-content: right;
            cursor: pointer;
        }

        span#settingButton > i {
            margin-right: 0.2rem;
        }

        .modal-body {
            min-height: 500px;
        }
    </style>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <!-- Bootstrap icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">
</head>

<body>
    <div id="settings">

    </div>

    <div id="webhookInfo">
        <span id="webhookUrl"></span>
    </div>

    <canvas id="bubbles"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
        crossorigin="anonymous"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
</body>

</html>