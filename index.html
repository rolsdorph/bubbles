<html>

<head>
    <title>
        Bubbles
    </title>
    <script type="application/javascript">
        const DEBUG_MODE = true;
        const WS_SERVER = "ws://127.0.0.1:3001";
        const WS_PROTOCOL = "bubbler-v0";
        const TICK_MS = 20; // 50 FPS
        const FLOAT_SPEED = 0.6;
        const COLORS = ['red', 'green', 'blue', 'purple', 'yellow', 'orange'];
        let lastRender;

        function randomColor() {
            return COLORS[randomInRange(0, COLORS.length - 1)];
        }

        const bubbles = [];
        const bubbleConfig = {
            fieldExtractor: () => randomInRange(25, 100),
            radiusMapper: r => r,
            colorMapper: randomColor
        }

        function extractNumericOrDefault(extractor, defaultValue) {
            return data => {
                const extracted = extractor(data);
                if (typeof extracted == 'number') {
                    return extracted;
                } else {
                    return defaultValue;
                }
            }
        }

        function nestedFieldExtractor(fields) {
            return data => {
                let currentNode = data;
                for (let field of fields) {
                    currentNode = currentNode[field];
                    if (currentNode === undefined) {
                        return undefined;
                    }
                }
                return currentNode;
            };
        }

        function addBubble(radius, fill) {
            bubbles.push({
                // Spawn at a random horizontal position, fully inside the viewport:
                "x": randomInRange(radius, window.innerWidth - radius),
                // Spawn just below the viewport:
                "y": window.innerHeight + radius,
                "r": radius,
                "fillStyle": fill
            });
        }

        function randomInRange(minInclusive, maxInclusive) {
            return Math.floor(Math.random() * (maxInclusive - minInclusive + 1) + minInclusive);
        }

        function fillFor(targetValue) {
            return "red";
        }

        function initiateBootstrapTooltips() {
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
        }

        function start() {
            initiateBootstrapTooltips();
            const modal = new bootstrap.Modal('#settings-modal');
            document.getElementById('settings').addEventListener('click', () => modal.show());
            if (DEBUG_MODE) {
                sendTestSetupMessage();
                sendTestDataMessage();
                setInterval(sendTestDataMessage, 5000);
            } else {
                const ws = new WebSocket(WS_SERVER, WS_PROTOCOL);
                ws.onmessage = handleWsMessage;
            }
            window.requestAnimationFrame(render);
        }

        function handleWsMessage(event) {
            const msg = JSON.parse(event.data);
            if (msg.type == "setupInfo") {
                document.getElementById("webhookUrl").innerText = msg.webhookUrl;
            } else if (msg.type == "webhookMessage") {
                let value = bubbleConfig.fieldExtractor(msg['dataFromWebhook']);
                addBubble(bubbleConfig.radiusMapper(value), bubbleConfig.colorMapper(value));
            } else {
                console.log(`Unexpected message type: ${msg.type}`);
            }
        }

        function render(timestamp) {
            if (lastRender === undefined) {
                lastRender = timestamp;
            }

            if (timestamp - lastRender > TICK_MS) {
                const canvas = document.getElementById("bubbles");
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;

                const ctx = canvas.getContext('2d');
                for (let i = bubbles.length - 1; i >= 0; i--) {
                    const bubble = bubbles[i];

                    bubble.y -= FLOAT_SPEED;
                    if (bubble.y < -bubble.r) {
                        // Fully out of view, remove it:
                        bubbles.splice(i, 1);
                    }
                    ctx.beginPath();
                    ctx.arc(bubble.x, bubble.y, bubble.r, 0, 2 * Math.PI, false);
                    ctx.fillStyle = bubble.fillStyle;
                    ctx.fill();
                }
            }

            window.requestAnimationFrame(render);
        }

        function sendTestSetupMessage() {
            handleWsMessage({
                "data": JSON.stringify({
                    "type": "setupInfo",
                    "webhookUrl": "http://localhost:3000/mAdS"
                })
            });
        }

        function sendTestDataMessage() {
            handleWsMessage({
                "data": JSON.stringify({
                    "type": "webhookMessage",
                    "dataFromWebhook": {
                        "room": {
                            "data": {
                                "temperature": randomInRange(5, 100)
                            }
                        }
                    }
                })
            });
        }
    </script>

    <style>
        body {
            padding: 0;
            margin: 0;
        }

        div#webhookInfo {
            position: absolute;
            margin-top: 10%;
            width: 100%;

            display: flex;
            justify-content: center;
            align-items: center;

            font-size: 50px;
        }

        div#settings {
            display: flex;
            justify-content: right;
            margin-right: 1rem;
            margin-top: 1rem;
            cursor: pointer;
        }
    </style>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <!-- Bootstrap icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">
</head>

<body onload="start();">
    <div id="settings">
        <div id="settingButton">
            <i id="settings-icon" class="bi bi-gear"></i>
            Bubbles
        </div>
    </div>

    <div id="webhookInfo">
        <span id="webhookUrl"></span>
    </div>

    <div id="settings-modal" class="modal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body row">
                    <form class="container mb-4 p-4">
                        <div class="row mb-4 text-center">
                            <h4>
                                Radius calculation
                            </h4>
                        </div>
                        <div class="row">
                            <div id="radius-calculation" class="btn-group mb-3" role="group"
                                aria-label="Radius calculation">
                                <input type="radio" name="radiusCalculation" id="radius-random" class="btn-check">
                                <label class="btn btn-outline-primary" for="radius-random">Random</label>

                                <input type="radio" name="radiusCalculation" id="radius-fixed" class="btn-check">
                                <label class="btn btn-outline-primary" for="radius-fixed">Fixed</label>

                                <input type="radio" name="radiusCalculation" id="radius-data" class="btn-check">
                                <label class="btn btn-outline-primary active" for="radius-data">Dynamic</label>
                            </div>
                        </div>
                        <div class="row mb-4 text-muted text-center">
                            The bubble size is decided by a JSON field in the webhook message payload. The size will be
                            linearly interpolated between minimum and maximum value.
                        </div>
                        <div class="row mb-3 align-items-center">
                            <div class="col-4">
                                JSON field
                            </div>
                            <div class="col-lg-5 col-md-6">
                                <input type="text" id="radius-field-name" class="form-control"
                                    aria-describedby="radius-field-name-help" placeholder="my.data.field">
                            </div>
                            <div class="col">
                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="right"
                                    data-bs-offset="[0,20]"
                                    title="The JSON field to fetch a numeric value from. Use dots for nested fields."></i>
                            </div>
                        </div>
                        <div class="row mb-3 align-items-center">
                            <div class="col-4">
                                Value range
                            </div>
                            <div class="col-lg-5 col-md-6">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <input type="number" id="radius-field-min" class="form-control"
                                            placeholder="Min">
                                    </div>
                                    -
                                    <div class="col">
                                        <input type="number" id="radius-field-max" class="form-control"
                                            placeholder="Max">
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <i class="bi bi-info-circle" data-bs-toggle="tooltip" data-bs-placement="right"
                                    data-bs-offset="[0,20]"
                                    title="Values outside this range map to the smallest/largest bubble size."></i>
                            </div>
                        </div>
                        <div class="row mb-3 align-items-center">
                            <div class="col-4">Smallest bubble radius</div>
                            <div class="col-lg-5 col-md-6">
                                <input type="range" class="form-range" min="5" max="100" value="25">
                            </div>
                            <div class="col">
                                25px
                            </div>
                        </div>
                        <div class="row align-items-center">
                            <div class="col-4">Largest bubble radius</div>
                            <div class="col-lg-5 col-md-6">
                                <input type="range" class="form-range" min="5" max="100" value="60">
                            </div>
                            <div class="col">
                                60px
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <canvas id="bubbles"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
        crossorigin="anonymous"></script>
</body>

</html>