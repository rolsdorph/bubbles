<html>

<head>
    <title>
        Bubbles
    </title>
    <script type="module">
        import { BubbleSimulator } from './out/bubble_simulator.js';
        import { randomInRange } from './out/util.js';
        import { RadiusConfig } from './out/config_modal/radius_config.js';
        import { RANDOM, FIXED, DYNAMIC } from './out/types.js';

        const DEBUG_MODE = true;
        const WS_SERVER = "ws://127.0.0.1:3001";
        const WS_PROTOCOL = "bubbler-v0";
        const COLORS = ['red', 'green', 'blue', 'purple', 'yellow', 'orange'];
        let bubbler;

        function randomColor() {
            return COLORS[randomInRange(0, COLORS.length - 1)];
        }

        let bubbleConfig = {
            fieldExtractor: () => randomInRange(25, 100),
            radiusMapper: r => r,
            colorMapper: randomColor
        }

        function extractNumericOrDefault(extractor, defaultValue) {
            return data => {
                const extracted = extractor(data);
                if (typeof extracted == 'number') {
                    return extracted;
                } else {
                    return defaultValue;
                }
            }
        }

        function nestedFieldExtractor(fields) {
            return data => {
                let currentNode = data;
                for (let field of fields) {
                    currentNode = currentNode[field];
                    if (currentNode === undefined) {
                        return undefined;
                    }
                }
                return currentNode;
            };
        }

        function buildConfig(newConfig) {
            if (newConfig.radiusType === RANDOM) {
                return {
                    fieldExtractor: () => randomInRange(newConfig.minRadius, newConfig.maxRadius),
                    radiusMapper: r => r
                };
            } else if (newConfig.radiusType === FIXED) {
                return {
                    fieldExtractor: () => newConfig.radius,
                    radiusMapper: r => r
                };
            } else if (newConfig.radiusType === DYNAMIC) {
                const fields = newConfig.jsonField.split('.');
                return {
                    fieldExtractor: extractNumericOrDefault(
                        nestedFieldExtractor(fields),
                        newConfig.minRadius
                    ),
                    radiusMapper: interpolate(newConfig.minValue, newConfig.maxValue, newConfig.minRadius, newConfig.maxRadius)
                };
            } else {
                console.error(`Unknown radius strategy: ${newConfig.radiusType}`);
            }
        }

        function interpolate(dataRangeMin, dataRangeMax, valueRangeMin, valueRangeMax) {
            return dataValue => {
                if (dataValue <= dataRangeMin) {
                    return valueRangeMin;
                }

                if (dataValue >= dataRangeMax) {
                    return valueRangeMax;
                }

                // How many percent of the min-max range do we fill?
                const position = (dataValue - dataRangeMin) / (dataRangeMax - dataRangeMin);

                // Starting at the min radius, fill the same percentage of the value range
                return valueRangeMin + (position * (valueRangeMax - valueRangeMin));
            };
        }

        function onConfigChange(newConfig) {
            bubbleConfig = buildConfig(newConfig);
            bubbleConfig.colorMapper = randomColor;
        }

        function start() {
            ReactDOM.createRoot(document.getElementById("settings")).render(
                React.createElement(RadiusConfig, { 'onSave': onConfigChange })
            );

            bubbler = new BubbleSimulator(document.getElementById('bubbles'));
            bubbler.start();

            if (DEBUG_MODE) {
                sendTestSetupMessage();
                sendTestDataMessage();
                setInterval(sendTestDataMessage, 5000);
            } else {
                const ws = new WebSocket(WS_SERVER, WS_PROTOCOL);
                ws.onmessage = handleWsMessage;
            }
        }

        function handleWsMessage(event) {
            const msg = JSON.parse(event.data);
            if (msg.type == "setupInfo") {
                document.getElementById("webhookUrl").innerText = msg.webhookUrl;
            } else if (msg.type == "webhookMessage") {
                let value = bubbleConfig.fieldExtractor(msg['dataFromWebhook']);
                bubbler.addBubble(bubbleConfig.radiusMapper(value), bubbleConfig.colorMapper(value));
            } else {
                console.error(`Unexpected message type: ${msg.type}`);
            }
        }

        function sendTestSetupMessage() {
            handleWsMessage({
                "data": JSON.stringify({
                    "type": "setupInfo",
                    "webhookUrl": "http://localhost:3000/mAdS"
                })
            });
        }

        function sendTestDataMessage() {
            handleWsMessage({
                "data": JSON.stringify({
                    "type": "webhookMessage",
                    "dataFromWebhook": {
                        "room": {
                            "data": {
                                "temperature": randomInRange(5, 100)
                            }
                        }
                    }
                })
            });
        }

        document.addEventListener('DOMContentLoaded', start);
    </script>

    <style>
        body {
            padding: 0;
            margin: 0;
        }

        div#webhookInfo {
            position: absolute;
            margin-top: 10%;
            width: 100%;

            display: flex;
            justify-content: center;
            align-items: center;

            font-size: 50px;
        }

        div#settings {
            position: absolute;
            width: 100%;
            padding-right: 0.5rem;
            padding-top: 0.5rem;

            display: flex;
            justify-content: right;
            cursor: pointer;
        }

        span#settingButton>i {
            margin-right: 0.2rem;
        }

        .modal-body {
            min-height: 500px;
        }
    </style>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <!-- Bootstrap icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css">
</head>

<body>
    <div id="settings">

    </div>

    <div id="webhookInfo">
        <span id="webhookUrl"></span>
    </div>

    <canvas id="bubbles"></canvas>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
        crossorigin="anonymous"></script>

    <!-- React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
</body>

</html>